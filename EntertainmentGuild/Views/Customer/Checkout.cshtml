@model EntertainmentGuild.ViewModels.CheckoutViewModel

@{
    ViewData["Title"] = "Checkout";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<div class="container mt-5">
    <form method="post" asp-action="PlaceOrder" asp-controller="Customer">
        <div class="row">
            <!-- Left -->
            <div class="col-md-7">
                <h4>Customer Information</h4>
                <p><strong>Email:</strong> @Model.UserEmail</p>

                <hr />
                <h5>Delivery</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="delivery" id="ship" value="Ship" checked />
                    <label class="form-check-label" for="ship">Ship</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="delivery" id="pickup" value="Pickup" />
                    <label class="form-check-label" for="pickup">Click & Collect</label>
                </div>

                <div class="mt-3">
                    <h5>Shipping Address</h5>
                    @if (Model.Addresses.Any())
                    {
                        <select class="form-select" name="SelectedAddress">
                            @foreach (var addr in Model.Addresses)
                            {
                                <option value="@addr.Id">@addr.AddressLine, @addr.City, @addr.State, @addr.PostalCode</option>
                            }
                        </select>
                    }
                    else
                    {
                        <p class="text-muted">No saved addresses. <a href="/Customer/ViewAddress">Add one</a>.</p>
                    }
                </div>

                <div class="mt-4">
                    <h5>Shipping Method</h5>
                    <select class="form-select" id="shippingMethod" name="ShippingMethod">
                        <option value="0">Standard (3-5 days) - Free</option>
                        <option value="8">Express (1-2 days) - $8.00</option>
                        <option value="15">Next-Day Delivery - $15.00</option>
                    </select>
                </div>

                <div class="mt-4">
                    <h5>Payment Method</h5>
                    @if (Model.Cards.Any())
                    {
                        <select class="form-select" name="SelectedCardId">
                            <option value="">-- Select Card --</option>
                            @foreach (var card in Model.Cards)
                            {
                                <option value="@card.Id">
                                    @card.CardType @card.Last4Digits
                                </option>
                            }
                        </select>
                    }
                    else
                    {
                        <p class="text-muted">No saved cards. <a href="/Customer/Account">Add one</a>.</p>
                    }
                </div>

                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" name="newsletter" checked />
                    <label class="form-check-label">
                        Sign me up for news and offers from this store
                    </label>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-3">Pay Now</button>

                <!-- Hidden selected items -->
                @foreach (var item in Model.CartItems)
                {
                    <input type="hidden" name="SelectedCartIds" value="@item.Product.Id" />
                }
            </div>

            <!-- Right: Summary -->
            <div class="col-md-5 bg-light p-4 rounded shadow-sm">
                <h5>Order Summary</h5>
                <ul class="list-group mb-3">
                    @foreach (var item in Model.CartItems)
                    {
                        <li class="list-group-item d-flex justify-content-between">
                            <div>
                                <strong>@item.Product.Name</strong><br />
                                <small class="text-muted">@item.Product.Category - @item.Product.SubCategory</small>
                            </div>
                            <span>@item.Product.Price.ToString("C")</span>
                        </li>
                    }
                </ul>

                <div class="d-flex justify-content-between">
                    <span>Subtotal</span>
                    <span id="subtotal">@Model.Subtotal.ToString("C")</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Shipping</span>
                    <span id="shippingFee">$0.00</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Tax</span>
                    <span>@Model.Tax.ToString("C")</span>
                </div>
                <hr />
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total</span>
                    <span id="totalAmount" class="text-primary">
                        @(Model.Subtotal + Model.Tax).ToString("C")
                    </span>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const shippingSelect = document.getElementById("shippingMethod");
        const subtotalValue = parseFloat("@Model.Subtotal");
        const taxValue = parseFloat("@Model.Tax");

        function updateTotal() {
            const shippingFee = parseFloat(shippingSelect.value);
            const total = subtotalValue + taxValue + shippingFee;

            document.getElementById("shippingFee").textContent = "$" + shippingFee.toFixed(2);
            document.getElementById("totalAmount").textContent = "$" + total.toFixed(2);
        }

        shippingSelect.addEventListener("change", updateTotal);
        updateTotal();
    </script>
}
