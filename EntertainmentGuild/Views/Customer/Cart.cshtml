@model List<EntertainmentGuild.Models.Cart>

@{
    ViewData["Title"] = "Your Cart";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<div class="container mt-4 mb-5">

    <h3 class="fw-bold mb-4" style="color: #b29b4b;">🛒 Your Shopping Cart</h3>

    @if (!Model.Any())
    {
        <!-- Show warning message if cart is empty -->
        <div class="alert alert-warning">Your cart is empty.</div>
    }
    else
    {
        <form asp-controller="Customer" method="post" id="checkoutForm">
            @Html.AntiForgeryToken()
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th>
                                <!-- Checkbox to select/deselect all items -->
                                <input type="checkbox" id="selectAll" aria-label="Select all items" />
                            </th>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Subtotal</th>
                            <th>Added</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="align-middle">
                                <td>
                                    <!-- Checkbox for selecting this item, with data-price for total calculation -->
                                    <input type="checkbox"
                                           name="selectedCartIds"
                                           value="@item.Id"
                                           class="form-check-input select-item"
                                           data-price="@(((item.Product?.Price ?? 0) * item.Quantity).ToString("F2"))"
                                           aria-label="Select @(item.Product?.Name ?? "item")" />
                                </td>
                                <td>
                                    @if (item.Product?.ImageData != null)
                                    {
                                        <img src="data:image/png;base64,@Convert.ToBase64String(item.Product.ImageData)"
                                             class="rounded shadow-sm"
                                             style="width: 80px; height: 80px; object-fit: cover;" />
                                    }
                                    else
                                    {
                                        <div class="text-muted">No image</div>
                                    }
                                </td>
                                <td class="fw-semibold">@(item.Product?.Name ?? "N/A")</td>
                                <td>@($"{item.Product?.Category ?? "N/A"} &gt; {item.Product?.SubCategory ?? "N/A"}")</td>
                                <td style="color: #a38b30;">¥@((item.Product?.Price ?? 0).ToString("F2"))</td>
                                <td>@item.Quantity</td>
                                <td style="color: #a38b30;">¥@(((item.Product?.Price ?? 0) * item.Quantity).ToString("F2"))</td>
                                <td><small>@item.AddedAt.ToString("g")</small></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Section showing total price and action buttons -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4">
                <div class="mb-3 mb-md-0">
                    <strong>Total: </strong>
                    <span id="totalPrice" class="fs-4 fw-bold" style="color: #b29b4b;">¥0.00</span>
                </div>
                <div class="d-flex gap-3">
                    <!-- Button to delete selected cart items -->
                    <button type="submit"
                            class="btn btn-outline-danger px-4"
                            formaction="@Url.Action("DeleteSelectedFromCart", "Customer")"
                            formmethod="post">
                        🗑 Delete Selected
                    </button>
                    <!-- Button to proceed to checkout with selected items -->
                    <button type="submit"
                            class="btn btn-warning px-4 text-white"
                            formaction="@Url.Action("Checkout", "Customer")"
                            formmethod="post"
                            style="background-color: #b29b4b; border: none;">
                        💳 Checkout
                    </button>
                </div>
            </div>
        </form>
    }
</div>

<footer class="mt-5 pt-4 pb-3 bg-light text-dark border-top shadow-sm">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-3">
                <h5 class="fw-bold" style="color:#b29b4b;">e-Closet</h5>
                <p class="text-muted small">
                    <!-- Your curated fashion corner description -->
                    Your curated fashion corner.<br />
                    Blending style &amp; soul with a touch of music.
                </p>
            </div>

            <div class="col-md-4 mb-3">
                <h6 class="fw-bold">Quick Links</h6>
                <ul class="list-unstyled small">
                    <li><a href="/Customer/Index" class="text-decoration-none text-dark">Home</a></li>
                    <li><a href="/Customer/Product" class="text-decoration-none text-dark">Products</a></li>
                    <li><a href="/Customer/Cart" class="text-decoration-none text-dark">Cart</a></li>
                    <li><a href="/Customer/Account" class="text-decoration-none text-dark">My Account</a></li>
                </ul>
            </div>

            <div class="col-md-4 mb-3">
                <h6 class="fw-bold">Contact</h6>
                <p class="small mb-1"><i class="bi bi-envelope me-1"></i> support@ecloset.com</p>
                <p class="small">
                    <i class="bi bi-music-note-beamed me-1"></i> Follow us on
                    <a href="#" class="text-decoration-none text-dark">Instagram</a>
                </p>
            </div>
        </div>

        <div class="text-center mt-4 border-top pt-3 small text-muted">
            <!-- Copyright text with current year -->
            © @DateTime.Now.Year e-Closet. All rights reserved.
        </div>
    </div>
</footer>

@section Scripts {
    <script>
        // Select all item checkboxes and total price display element
        const checkboxes = document.querySelectorAll('.select-item');
        const totalPriceSpan = document.getElementById('totalPrice');
        const selectAllCheckbox = document.getElementById('selectAll');

        // Update total price based on checked items
        function updateTotal() {
            let total = 0;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseFloat(cb.dataset.price || 0);
                }
            });
            totalPriceSpan.textContent = "¥" + total.toFixed(2);
        }

        // Event listener for 'select all' checkbox
        selectAllCheckbox.addEventListener('change', function () {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateTotal();
        });

        // Event listeners for individual checkboxes
        checkboxes.forEach(cb => cb.addEventListener('change', updateTotal));

        // Prevent form submission if no items selected
        document.getElementById('checkoutForm').addEventListener('submit', function (e) {
            const selected = Array.from(checkboxes).filter(cb => cb.checked);
            if (selected.length === 0) {
                e.preventDefault();
                alert("Please select at least one item.");
            }
        });

        // Initialize total price on page load
        updateTotal();
    </script>
}
